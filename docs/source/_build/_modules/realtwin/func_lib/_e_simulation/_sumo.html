

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>realtwin.func_lib._e_simulation._sumo &mdash; realtwin</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/realtwin_css.css?v=836a7079" />


      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >



          <a href="../../../../index.html" class="icon icon-home">
            realtwin
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Real-Twin Navigation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/intro.html">About Real-Twin</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/install.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/realtwin_simulator.html">Supported Simulator</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/realtwin_prepare.html">Preparation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/realtwin_generation.html">Scenario Generation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/api.html">realtwin API Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/support.html">Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/support.html#citation-request">Citation Request</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/support.html#official-links">Official Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/support.html#license">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/acknowledgements.html">Acknowledgements</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">realtwin</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">realtwin.func_lib._e_simulation._sumo</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <h1>Source code for realtwin.func_lib._e_simulation._sumo</h1><div class="highlight"><pre>
<span></span><span class="c1">##############################################################################</span>
<span class="c1"># Copyright (c) 2024, Oak Ridge National Laboratory                          #</span>
<span class="c1"># All rights reserved.                                                       #</span>
<span class="c1">#                                                                            #</span>
<span class="c1"># This file is part of RealTwin and is distributed under a MIT               #</span>
<span class="c1"># license. For the licensing terms see the LICENSE file in the top-level     #</span>
<span class="c1"># directory.                                                                 #</span>
<span class="c1">#                                                                            #</span>
<span class="c1"># Contributors (Add you name below to acknowledge your contribution):        #</span>
<span class="c1"># Xiangyong Roy Luo                                                          #</span>
<span class="c1">##############################################################################</span>
<span class="sd">&quot;&quot;&quot;The module to handle the SUMO simulation for the real-twin developed by ORNL ARMS group.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ET</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">xml.dom.minidom</span><span class="w"> </span><span class="kn">import</span> <span class="n">parseString</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xml.dom.minidom</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">minidom</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyufunc</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pf</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>


<div class="viewcode-block" id="SUMOPrep">
<a class="viewcode-back" href="../../../../pages/api/realtwin.func_lib.SUMOPrep.html#realtwin.func_lib.SUMOPrep">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SUMOPrep</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The class to handle the SUMO simulation for the real-twin developed by ORNL ARMS group.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SUMOPrep.__init__">
<a class="viewcode-back" href="../../../../pages/api/realtwin.func_lib.SUMOPrep.html#realtwin.func_lib.SUMOPrep.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Network</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># self.NetworkWithElevation = {}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Demand</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Signal</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># add kwargs to the class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">importNetwork</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ConcreteScn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The function to import the network from the OpenDrive file and convert it to SUMO network file.&quot;&quot;&quot;</span>

        <span class="c1"># self.Network = ConcreteScn.Supply.Network</span>
        <span class="c1"># self.NetworkWithElevation = ConcreteScn.Supply.NetworkWithElevation</span>
        <span class="n">NetworkName</span> <span class="o">=</span> <span class="n">ConcreteScn</span><span class="o">.</span><span class="n">Supply</span><span class="o">.</span><span class="n">NetworkName</span>

        <span class="c1"># get output path from the configuration dict</span>
        <span class="n">path_output</span> <span class="o">=</span> <span class="n">ConcreteScn</span><span class="o">.</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_dir&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SUMOPath</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">path2linux</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span> <span class="s1">&#39;SUMO&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUMOPath</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUMOPath</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUMOPath</span><span class="p">)</span>

        <span class="c1"># Sumo combine the OpenDrive file to sumo network file</span>
        <span class="n">path_open_drive</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">path2linux</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;OpenDrive/</span><span class="si">{</span><span class="n">NetworkName</span><span class="si">}</span><span class="s1">.xodr&#39;</span><span class="p">))</span>
        <span class="n">path_sumo_net</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">path2linux</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;SUMO/</span><span class="si">{</span><span class="n">NetworkName</span><span class="si">}</span><span class="s1">.net.xml&#39;</span><span class="p">))</span>

        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cmd/c &quot;netconvert --opendrive </span><span class="si">{</span><span class="n">path_open_drive</span><span class="si">}</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39; -o </span><span class="si">{</span><span class="n">path_sumo_net</span><span class="si">}</span><span class="s1"> --no-internal-links&quot;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Network</span> <span class="o">=</span> <span class="n">path_sumo_net</span>

        <span class="c1"># Load the XML file</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Network</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="c1"># Find all junctions</span>
        <span class="n">junctions</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;junction&#39;</span><span class="p">)</span>

        <span class="c1"># Function to extract road ids from incLanes attribute</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_road_ids_from_incLanes</span><span class="p">(</span><span class="n">incLanes</span><span class="p">):</span>
            <span class="n">lane_ids</span> <span class="o">=</span> <span class="n">incLanes</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">road_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">lane_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="n">lane_ids</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">road_ids</span><span class="p">)</span>

        <span class="c1"># Find all junctions with only one road connecting</span>
        <span class="n">junctions_single_road</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">junction</span> <span class="k">for</span> <span class="n">junction</span> <span class="ow">in</span> <span class="n">junctions</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_road_ids_from_incLanes</span><span class="p">(</span><span class="n">junction</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;incLanes&#39;</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Iterate over junctions with only one road connecting</span>
        <span class="k">for</span> <span class="n">junction</span> <span class="ow">in</span> <span class="n">junctions_single_road</span><span class="p">:</span>
            <span class="c1"># Get the id of the only road connected to the junction</span>
            <span class="n">road_id</span> <span class="o">=</span> <span class="n">get_road_ids_from_incLanes</span><span class="p">(</span><span class="n">junction</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;incLanes&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Find all connections where from=road_id and dir=&#39;t&#39;</span>
            <span class="n">connections_to_delete</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;.//connection[@from=&#39;</span><span class="si">{</span><span class="n">road_id</span><span class="si">}</span><span class="s2">&#39;][@dir=&#39;t&#39;]&quot;</span><span class="p">)</span>
            <span class="c1"># Delete these connections</span>
            <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">connections_to_delete</span><span class="p">:</span>
                <span class="n">root</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

        <span class="c1"># Write the modified tree back to the file</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Network</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">importDemand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ConcreteScn</span><span class="p">,</span> <span class="n">SimulationStartTime</span><span class="p">,</span> <span class="n">SimulationEndTime</span><span class="p">,</span> <span class="n">SeedSet</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The function to import the demand from the demand file and convert it to SUMO demand file.&quot;&quot;&quot;</span>

        <span class="n">NetworkName</span> <span class="o">=</span> <span class="n">ConcreteScn</span><span class="o">.</span><span class="n">Supply</span><span class="o">.</span><span class="n">NetworkName</span>
        <span class="c1"># Create the .flow.xml</span>
        <span class="n">InflowDf</span> <span class="o">=</span> <span class="n">ConcreteScn</span><span class="o">.</span><span class="n">Demand</span><span class="o">.</span><span class="n">Inflow</span>
        <span class="n">InflowDf</span><span class="p">[</span><span class="s1">&#39;IntervalStart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InflowDf</span><span class="p">[</span><span class="s1">&#39;IntervalStart&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">InflowDf</span><span class="p">[</span><span class="s1">&#39;IntervalEnd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InflowDf</span><span class="p">[</span><span class="s1">&#39;IntervalEnd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">InflowDf</span> <span class="o">=</span> <span class="n">InflowDf</span><span class="p">[(</span><span class="n">InflowDf</span><span class="p">[</span><span class="s1">&#39;IntervalStart&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">SimulationStartTime</span><span class="p">)</span>
                            <span class="o">&amp;</span> <span class="p">(</span><span class="n">InflowDf</span><span class="p">[</span><span class="s1">&#39;IntervalEnd&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">SimulationEndTime</span><span class="p">)]</span>

        <span class="n">routes</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;routes&#39;</span><span class="p">)</span>
        <span class="n">v_type</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span> <span class="s1">&#39;vType&#39;</span><span class="p">)</span>
        <span class="n">v_type</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>
        <span class="n">v_type</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;passenger&#39;</span><span class="p">)</span>
        <span class="n">InflowDict</span> <span class="o">=</span> <span class="n">InflowDf</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
        <span class="n">FlowID</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">InflowData</span> <span class="ow">in</span> <span class="n">InflowDict</span><span class="p">:</span>
            <span class="n">FlowID</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span> <span class="s1">&#39;flow&#39;</span><span class="p">)</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">FlowID</span><span class="p">))</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;begin&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">InflowData</span><span class="p">[</span><span class="s1">&#39;IntervalStart&#39;</span><span class="p">]))</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">InflowData</span><span class="p">[</span><span class="s1">&#39;IntervalEnd&#39;</span><span class="p">]))</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">InflowData</span><span class="p">[</span><span class="s1">&#39;OpenDriveFromID&#39;</span><span class="p">])))</span>

            <span class="c1"># may need to change</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">InflowData</span><span class="p">[</span><span class="s1">&#39;Count&#39;</span><span class="p">]))</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>

        <span class="c1"># &lt;flow begin=&quot;0.0&quot; end=&quot;3600.0&quot; from=&quot;&quot; id=&quot;&quot; number=&quot;&quot; type=&quot;car&quot;/&gt;</span>
        <span class="n">TreeInflow</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">routes</span><span class="p">)</span>
        <span class="n">path_sumo_flow</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">path2linux</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUMOPath</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">NetworkName</span><span class="si">}</span><span class="s1">.flow.xml&#39;</span><span class="p">))</span>
        <span class="n">TreeInflow</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path_sumo_flow</span><span class="p">,</span>
                         <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create the .turn.xml</span>
        <span class="n">TurnDf</span> <span class="o">=</span> <span class="n">ConcreteScn</span><span class="o">.</span><span class="n">Route</span><span class="o">.</span><span class="n">TurningRatio</span>
        <span class="n">TurnDf</span><span class="p">[</span><span class="s1">&#39;IntervalStart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TurnDf</span><span class="p">[</span><span class="s1">&#39;IntervalStart&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">TurnDf</span><span class="p">[</span><span class="s1">&#39;IntervalEnd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TurnDf</span><span class="p">[</span><span class="s1">&#39;IntervalEnd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">TurnDf</span> <span class="o">=</span> <span class="n">TurnDf</span><span class="p">[(</span><span class="n">TurnDf</span><span class="p">[</span><span class="s1">&#39;IntervalStart&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">SimulationStartTime</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">TurnDf</span><span class="p">[</span><span class="s1">&#39;IntervalEnd&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">SimulationEndTime</span><span class="p">)]</span>
        <span class="n">turns</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;turns&#39;</span><span class="p">)</span>
        <span class="c1"># Create the &#39;interval&#39; element</span>
        <span class="n">IntervalSet</span> <span class="o">=</span> <span class="n">TurnDf</span><span class="p">[[</span><span class="s1">&#39;IntervalStart&#39;</span><span class="p">,</span> <span class="s1">&#39;IntervalEnd&#39;</span><span class="p">]</span>
                             <span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">IntervalData</span> <span class="ow">in</span> <span class="n">IntervalSet</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">Interval</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">turns</span><span class="p">,</span> <span class="s1">&#39;interval&#39;</span><span class="p">)</span>
            <span class="n">Interval</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;begin&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">IntervalData</span><span class="p">[</span><span class="s1">&#39;IntervalStart&#39;</span><span class="p">]))</span>
            <span class="n">Interval</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">IntervalData</span><span class="p">[</span><span class="s1">&#39;IntervalEnd&#39;</span><span class="p">]))</span>

            <span class="n">TurnDfSubset</span> <span class="o">=</span> <span class="n">TurnDf</span><span class="p">[(</span><span class="n">TurnDf</span><span class="p">[</span><span class="s1">&#39;IntervalStart&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">IntervalData</span><span class="p">[</span><span class="s1">&#39;IntervalStart&#39;</span><span class="p">])</span>
                                  <span class="o">&amp;</span> <span class="p">(</span><span class="n">TurnDf</span><span class="p">[</span><span class="s1">&#39;IntervalEnd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">IntervalData</span><span class="p">[</span><span class="s1">&#39;IntervalEnd&#39;</span><span class="p">])]</span>
            <span class="n">TurnDictSubset</span> <span class="o">=</span> <span class="n">TurnDfSubset</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">TurnData</span> <span class="ow">in</span> <span class="n">TurnDictSubset</span><span class="p">:</span>
                <span class="n">edge_relation</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">Interval</span><span class="p">,</span> <span class="s1">&#39;edgeRelation&#39;</span><span class="p">)</span>
                <span class="n">edge_relation</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                    <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">TurnData</span><span class="p">[</span><span class="s1">&#39;OpenDriveFromID&#39;</span><span class="p">])))</span>

                <span class="c1"># may need to change</span>
                <span class="n">edge_relation</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">TurnData</span><span class="p">[</span><span class="s1">&#39;OpenDriveToID&#39;</span><span class="p">])))</span>

                <span class="c1"># may need to change</span>
                <span class="n">edge_relation</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">TurnData</span><span class="p">[</span><span class="s1">&#39;TurnRatio&#39;</span><span class="p">]))</span>
        <span class="c1"># &lt;edgeRelation from=&quot;&quot; probability=&quot;&quot; to=&quot;&quot;/&gt;</span>
        <span class="n">TreeTurn</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">turns</span><span class="p">)</span>
        <span class="c1"># Write the XML to the file</span>
        <span class="n">path_sumo_turn</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">path2linux</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUMOPath</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">NetworkName</span><span class="si">}</span><span class="s1">.turn.xml&#39;</span><span class="p">))</span>
        <span class="n">TreeTurn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path_sumo_turn</span><span class="p">,</span>
                       <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">Seed</span> <span class="ow">in</span> <span class="n">SeedSet</span><span class="p">:</span>
            <span class="c1"># Create the .rou.xml for each random seed</span>
            <span class="n">path_sumo_demand</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">path2linux</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUMOPath</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">NetworkName</span><span class="si">}</span><span class="s1">.rou.xml&#39;</span><span class="p">))</span>

            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cmd/c &quot;jtrrouter -r </span><span class="si">{</span><span class="n">path_sumo_flow</span><span class="si">}</span><span class="s1">&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39; -t </span><span class="si">{</span><span class="n">path_sumo_turn</span><span class="si">}</span><span class="s1">&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39; -n </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Network</span><span class="si">}</span><span class="s1"> --accept-all-destinations&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39; --remove-loops True --randomize-flows --seed </span><span class="si">{</span><span class="n">Seed</span><span class="si">}</span><span class="s1">&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39; -o </span><span class="si">{</span><span class="n">path_sumo_demand</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

            <span class="c1"># add element to the set object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Demand</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path_sumo_demand</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generateConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ConcreteScn</span><span class="p">,</span> <span class="n">SimulationStartTime</span><span class="p">,</span> <span class="n">SimulationEndTime</span><span class="p">,</span> <span class="n">SeedSet</span><span class="p">,</span> <span class="n">StepLength</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The function to generate the SUMO configuration file for the simulation.&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">prettify</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Return a pretty-printed XML string for the Element.&quot;&quot;&quot;</span>
            <span class="n">rough_string</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">re_parsed</span> <span class="o">=</span> <span class="n">parseString</span><span class="p">(</span><span class="n">rough_string</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">re_parsed</span><span class="o">.</span><span class="n">toprettyxml</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="s2">&quot;    &quot;</span><span class="p">)</span>
        <span class="c1"># Python code to generate 10 XML files with different seeds using xml.etree.ElementTree as ET</span>

        <span class="c1"># Create the root element</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;configuration&#39;</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;xmlns:xsi&#39;</span><span class="p">,</span> <span class="s1">&#39;http://www.w3.org/2001/XMLSchema-instance&#39;</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;xsi:noNamespaceSchemaLocation&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;http://sumo.dlr.de/xsd/duarouterConfiguration.xsd&#39;</span><span class="p">)</span>

        <span class="n">NetworkName</span> <span class="o">=</span> <span class="n">ConcreteScn</span><span class="o">.</span><span class="n">Supply</span><span class="o">.</span><span class="n">NetworkName</span>
        <span class="c1"># Add other elements to the root</span>
        <span class="k">for</span> <span class="n">Seed</span> <span class="ow">in</span> <span class="n">SeedSet</span><span class="p">:</span>
            <span class="n">random</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">)</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">random</span><span class="p">,</span> <span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">Seed</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>

            <span class="n">input_val</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">input_val</span><span class="p">,</span> <span class="s1">&#39;net-file&#39;</span><span class="p">,</span>
                          <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">NetworkName</span><span class="si">}</span><span class="s1">.net.xml&#39;</span><span class="p">})</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">input_val</span><span class="p">,</span> <span class="s1">&#39;route-files&#39;</span><span class="p">,</span>
                          <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">NetworkName</span><span class="si">}</span><span class="s1">.rou.xml&#39;</span><span class="p">})</span>

            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span>

            <span class="n">time</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="s1">&#39;begin&#39;</span><span class="p">,</span> <span class="p">{</span>
                          <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">SimulationStartTime</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                <span class="n">time</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">SimulationEndTime</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="s1">&#39;step-length&#39;</span><span class="p">,</span>
                          <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">StepLength</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>

            <span class="n">gui_only</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;gui_only&#39;</span><span class="p">)</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">gui_only</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;t&#39;</span><span class="p">})</span>

            <span class="n">report</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;report&#39;</span><span class="p">)</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="s1">&#39;no-warnings&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">})</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="s1">&#39;no-step-log&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">})</span>

            <span class="c1"># Update the seed value</span>

            <span class="n">xml_string</span> <span class="o">=</span> <span class="n">prettify</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            <span class="c1"># Write the XML string to a file</span>

            <span class="n">path_sumo_cfg</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">path2linux</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUMOPath</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">NetworkName</span><span class="si">}</span><span class="s1">.sumocfg&#39;</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_sumo_cfg</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xml_string</span><span class="p">)</span>

        <span class="c1"># 10 XML files &#39;config_1.smocfg&#39; to &#39;config_10.smocfg&#39; are created with different seed values</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">importSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ConcreteScn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The function to import the signal from the signal file and convert it to SUMO signal file.&quot;&quot;&quot;</span>

        <span class="n">input_dir</span> <span class="o">=</span> <span class="n">ConcreteScn</span><span class="o">.</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_dir&#39;</span><span class="p">)</span>
        <span class="n">control_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="s1">&#39;Control&#39;</span><span class="p">)</span>
        <span class="n">path_MatchupTable</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">path2linux</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="s1">&#39;MatchupTable.xlsx&#39;</span><span class="p">))</span>
        <span class="n">path_net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Network</span>

        <span class="c1"># check if the file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_net</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">path_net</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_MatchupTable</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">path_MatchupTable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path_MatchupTable</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.xlsx&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid file format: </span><span class="si">{</span><span class="n">path_MatchupTable</span><span class="si">}</span><span class="s2">. Expected .xlsx file.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">control_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">control_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">FixedTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FixedTime&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">signal_flag</span> <span class="o">=</span> <span class="n">sumo_signal_import</span><span class="p">(</span><span class="n">path_net</span><span class="p">,</span> <span class="n">path_MatchupTable</span><span class="p">,</span> <span class="n">FixedTime</span><span class="o">=</span><span class="n">FixedTime</span><span class="p">,</span> <span class="n">control_dir</span><span class="o">=</span><span class="n">control_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signal_flag</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  :SUMO signal updated at: </span><span class="si">{</span><span class="n">path_net</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in importing SUMO signal: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">process_signal_data</span><span class="p">(</span><span class="n">path_signal</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_signal</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">SignalData</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">SignalDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">current_table</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">current_table_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">removeflag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">SignalData</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">removeflag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">removeflag</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">):</span>
            <span class="n">removeflag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">current_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">current_table</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_table_data</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_table_data</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                    <span class="n">SignalDict</span><span class="p">[</span><span class="n">current_table</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

                <span class="n">current_table</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
                <span class="n">current_table_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_table_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">current_table_data</span><span class="p">:</span>
        <span class="n">SignalDict</span><span class="p">[</span><span class="n">current_table</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_table_data</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SignalDict</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_complete_state_string</span><span class="p">(</span><span class="n">protected_mov</span><span class="p">,</span> <span class="n">permitted_mov</span><span class="p">,</span> <span class="n">rtor_mov</span><span class="p">,</span> <span class="n">nm</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">nm</span>
    <span class="k">if</span> <span class="n">rtor_mov</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">rtor_mov</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">nm</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span>
    <span class="k">if</span> <span class="n">protected_mov</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">protected_mov</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">nm</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;G&#39;</span>
    <span class="k">if</span> <span class="n">permitted_mov</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">permitted_mov</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">nm</span> <span class="ow">and</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">):</span>
                <span class="n">state</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>


<span class="c1"># format the XML file to make it more readable</span>
<span class="k">def</span><span class="w"> </span><span class="nf">prettify_xml</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">xml_content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">parsed_xml</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">xml_content</span><span class="p">)</span>
    <span class="n">pretty_xml_as_string</span> <span class="o">=</span> <span class="n">parsed_xml</span><span class="o">.</span><span class="n">toprettyxml</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="s2">&quot;    &quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pretty_xml_as_string</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">sumo_signal_import</span><span class="p">(</span><span class="n">path_net</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path_MatchupTable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">FixedTime</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">control_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Control&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Import SUMO signal data from a MatchupTable to a SUMO network file.</span>
<span class="sd">    This function reads the signal data from the MatchupTable and updates the signal to the SUMO network file.</span>

<span class="sd">    Args:</span>
<span class="sd">        path_net (str): SUMO network file path.</span>
<span class="sd">        path_MatchupTable (str): Path to the MatchupTable file.</span>
<span class="sd">        FixedTime (bool): If True, the signal is fixed time, otherwise it is actuated. Default is False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the import was successful, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check if the file exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_net</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">path_net</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_MatchupTable</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">path_MatchupTable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path_MatchupTable</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.xlsx&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid file format: </span><span class="si">{</span><span class="n">path_MatchupTable</span><span class="si">}</span><span class="s2">. Expected .xlsx file.&quot;</span><span class="p">)</span>

    <span class="n">MatchupTable_UserInput</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">path_MatchupTable</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">merged_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;JunctionID_OpenDrive&quot;</span><span class="p">,</span> <span class="s2">&quot;File_GridSmart&quot;</span><span class="p">,</span> <span class="s2">&quot;Date_GridSmart&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;IntersectionName_GridSmart&quot;</span><span class="p">,</span> <span class="s2">&quot;File_Synchro&quot;</span><span class="p">,</span> <span class="s2">&quot;IntersectionID_Synchro&quot;</span><span class="p">,</span> <span class="s2">&quot;Need calibration?&quot;</span><span class="p">]</span>
    <span class="n">MatchupTable_UserInput</span><span class="p">[</span><span class="n">merged_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">MatchupTable_UserInput</span><span class="p">[</span><span class="n">merged_columns</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>

    <span class="c1"># Create synchro lookup table</span>
    <span class="n">lookup_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">lookup_df</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MatchupTable_UserInput</span><span class="p">[</span><span class="s1">&#39;IntersectionID_Synchro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">lookup_df</span><span class="p">[</span><span class="s1">&#39;SumoJunctionID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup_df</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">intid</span><span class="p">:</span> <span class="n">MatchupTable_UserInput</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">MatchupTable_UserInput</span><span class="p">[</span><span class="s1">&#39;IntersectionID_Synchro&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">intid</span><span class="p">,</span> <span class="s1">&#39;JunctionID_OpenDrive&#39;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">lookup_df</span><span class="p">[</span><span class="s1">&#39;StartingBound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup_df</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">intid</span><span class="p">:</span> <span class="n">MatchupTable_UserInput</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">MatchupTable_UserInput</span><span class="p">[</span><span class="s1">&#39;IntersectionID_Synchro&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">intid</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">MatchupTable_UserInput</span><span class="p">[</span><span class="s1">&#39;Bearing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">180</span><span class="p">),</span>
            <span class="s1">&#39;Turn_Synchro&#39;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">lookup_df</span> <span class="o">=</span> <span class="n">lookup_df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">synchro_file</span> <span class="o">=</span> <span class="n">MatchupTable_UserInput</span><span class="p">[</span><span class="s1">&#39;File_Synchro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">signal_path</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">path2linux</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">control_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">synchro_file</span><span class="p">)</span>
    <span class="n">SignalDict</span> <span class="o">=</span> <span class="n">process_signal_data</span><span class="p">(</span><span class="n">signal_path</span><span class="p">)</span>

    <span class="n">SignalInfo</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">unique_INTIDs</span> <span class="o">=</span> <span class="n">SignalDict</span><span class="p">[</span><span class="s1">&#39;Lanes&#39;</span><span class="p">][</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="c1"># Iterating through each unique &#39;INTID&#39; and gathering corresponding data from each table</span>
    <span class="k">for</span> <span class="n">intid</span> <span class="ow">in</span> <span class="n">unique_INTIDs</span><span class="p">:</span>
        <span class="n">SignalInfo</span><span class="p">[</span><span class="n">intid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Lanes&#39;</span><span class="p">:</span> <span class="n">SignalDict</span><span class="p">[</span><span class="s1">&#39;Lanes&#39;</span><span class="p">][</span><span class="n">SignalDict</span><span class="p">[</span><span class="s1">&#39;Lanes&#39;</span><span class="p">][</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">intid</span><span class="p">],</span>
            <span class="s1">&#39;Timeplans&#39;</span><span class="p">:</span> <span class="n">SignalDict</span><span class="p">[</span><span class="s1">&#39;Timeplans&#39;</span><span class="p">][</span><span class="n">SignalDict</span><span class="p">[</span><span class="s1">&#39;Timeplans&#39;</span><span class="p">][</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">intid</span><span class="p">],</span>
            <span class="s1">&#39;Phases&#39;</span><span class="p">:</span> <span class="n">SignalDict</span><span class="p">[</span><span class="s1">&#39;Phases&#39;</span><span class="p">][</span><span class="n">SignalDict</span><span class="p">[</span><span class="s1">&#39;Phases&#39;</span><span class="p">][</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">intid</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="n">Synchro</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">intid</span> <span class="ow">in</span> <span class="n">unique_INTIDs</span><span class="p">:</span>
        <span class="n">phases_df</span> <span class="o">=</span> <span class="n">SignalInfo</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s1">&#39;Phases&#39;</span><span class="p">]</span>
        <span class="n">transposed_df</span> <span class="o">=</span> <span class="n">phases_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">transposed_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;Phase&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">]</span> <span class="o">=</span> <span class="n">transposed_df</span>
    <span class="c1"># Filter Synchro to only keep entries where intid is in lookup_df[&#39;INTID&#39;]</span>
    <span class="n">Synchro</span> <span class="o">=</span> <span class="p">{</span><span class="n">intid</span><span class="p">:</span> <span class="n">df</span> <span class="k">for</span> <span class="n">intid</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">intid</span> <span class="ow">in</span> <span class="n">lookup_df</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">}</span>

    <span class="c1"># Updating the Synchro dictionary</span>
    <span class="k">for</span> <span class="n">intid</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;RECORDNAME&#39;</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s1">&#39;Phase&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;INTID&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;BRP&#39;</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_temp</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">]</span>

            <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BRP&#39;</span><span class="p">])</span>

            <span class="n">cols_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Phase&#39;</span><span class="p">,</span> <span class="s1">&#39;BRP&#39;</span><span class="p">]]</span>
            <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df_temp</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">df_temp</span><span class="p">[</span><span class="s1">&#39;BRP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">df_temp</span><span class="p">[</span><span class="n">cols_to_check</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))]</span>

            <span class="k">if</span> <span class="s1">&#39;MinGreen&#39;</span> <span class="ow">in</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;MaxGreen&#39;</span> <span class="ow">in</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MinGreen&#39;</span><span class="p">,</span> <span class="s1">&#39;MaxGreen&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_temp</span>

        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s1">&#39;Phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s1">&#39;Phase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">brp_values</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s1">&#39;BRP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s1">&#39;Barrier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">brp_values</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s1">&#39;Ring&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">brp_values</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">brp_values</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Adjusting the Synchro dictionary to place each table under Synchro[intid][&quot;Phases&quot;]</span>
    <span class="k">for</span> <span class="n">intid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Synchro</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">current_df</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">]</span>
        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Phases&quot;</span><span class="p">:</span> <span class="n">current_df</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">intid</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">lanes_df</span> <span class="o">=</span> <span class="n">SignalDict</span><span class="p">[</span><span class="s1">&#39;Lanes&#39;</span><span class="p">][</span><span class="n">SignalDict</span><span class="p">[</span><span class="s1">&#39;Lanes&#39;</span><span class="p">][</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">intid</span><span class="p">]</span>
        <span class="n">timeplans_df</span> <span class="o">=</span> <span class="n">SignalDict</span><span class="p">[</span><span class="s1">&#39;Timeplans&#39;</span><span class="p">][</span><span class="n">SignalDict</span><span class="p">[</span><span class="s1">&#39;Timeplans&#39;</span><span class="p">][</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">intid</span><span class="p">]</span>
        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lanes_df</span>
        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Timeplans&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeplans_df</span>

    <span class="c1"># Extracting the new order based on the &#39;StartingBound&#39; value</span>
    <span class="k">for</span> <span class="n">intid</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">cyclic_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SBR&#39;</span><span class="p">,</span> <span class="s1">&#39;SBT&#39;</span><span class="p">,</span> <span class="s1">&#39;SBL&#39;</span><span class="p">,</span> <span class="s1">&#39;SWR&#39;</span><span class="p">,</span> <span class="s1">&#39;SWT&#39;</span><span class="p">,</span> <span class="s1">&#39;SWL&#39;</span><span class="p">,</span> <span class="s1">&#39;WBR&#39;</span><span class="p">,</span> <span class="s1">&#39;WBT&#39;</span><span class="p">,</span> <span class="s1">&#39;WBL&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;NWR&#39;</span><span class="p">,</span> <span class="s1">&#39;NWT&#39;</span><span class="p">,</span> <span class="s1">&#39;NWL&#39;</span><span class="p">,</span> <span class="s1">&#39;NBR&#39;</span><span class="p">,</span> <span class="s1">&#39;NBT&#39;</span><span class="p">,</span> <span class="s1">&#39;NBL&#39;</span><span class="p">,</span> <span class="s1">&#39;NER&#39;</span><span class="p">,</span> <span class="s1">&#39;NET&#39;</span><span class="p">,</span> <span class="s1">&#39;NEL&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;EBR&#39;</span><span class="p">,</span> <span class="s1">&#39;EBT&#39;</span><span class="p">,</span> <span class="s1">&#39;EBL&#39;</span><span class="p">,</span> <span class="s1">&#39;SER&#39;</span><span class="p">,</span> <span class="s1">&#39;SET&#39;</span><span class="p">,</span> <span class="s1">&#39;SEL&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">intid</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lookup_df</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">starting_bound</span> <span class="o">=</span> <span class="n">lookup_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lookup_df</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">intid</span><span class="p">),</span> <span class="s1">&#39;StartingBound&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">starting_bound</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  :There is mismatch between SUMO turn and Synchro turn for Synchro junction </span><span class="si">{</span><span class="n">intid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">starting_bound</span> <span class="o">=</span> <span class="n">starting_bound</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;L&#39;</span>
            <span class="n">start_index</span> <span class="o">=</span> <span class="n">cyclic_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">starting_bound</span><span class="p">)</span>
            <span class="n">ordered_columns</span> <span class="o">=</span> <span class="n">cyclic_order</span><span class="p">[</span><span class="n">start_index</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cyclic_order</span><span class="p">[:</span><span class="n">start_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ordered_columns</span> <span class="o">=</span> <span class="n">cyclic_order</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">final_column_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">,</span> <span class="s1">&#39;INTID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ordered_columns</span>
        <span class="n">existing_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">final_column_order</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">][</span><span class="n">existing_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Associating Synchro[intid][&quot;Phases&quot;] with Synchro[intid][&quot;Lanes&quot;] by creating &quot;Protected&quot; and &quot;Permitted&quot; columns</span>
    <span class="k">for</span> <span class="n">intid</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">phases_df</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">]</span>
        <span class="n">lanes_df</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span>
        <span class="n">phases_df</span><span class="p">[</span><span class="s1">&#39;Protected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">phases_df</span><span class="p">[</span><span class="s1">&#39;Permitted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">phases_df</span><span class="p">[</span><span class="s1">&#39;RTOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">protected_rows</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Phase1&#39;</span><span class="p">,</span> <span class="s1">&#39;Phase2&#39;</span><span class="p">,</span> <span class="s1">&#39;Phase3&#39;</span><span class="p">,</span> <span class="s1">&#39;Phase4&#39;</span><span class="p">]</span>
        <span class="n">permitted_rows</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PermPhase1&#39;</span><span class="p">,</span> <span class="s1">&#39;PermPhase2&#39;</span><span class="p">,</span> <span class="s1">&#39;PermPhase3&#39;</span><span class="p">,</span> <span class="s1">&#39;PermPhase4&#39;</span><span class="p">]</span>
        <span class="n">existing_protected_rows</span> <span class="o">=</span> <span class="n">lanes_df</span><span class="p">[</span><span class="n">lanes_df</span><span class="p">[</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">protected_rows</span><span class="p">)]</span>
        <span class="n">existing_permitted_rows</span> <span class="o">=</span> <span class="n">lanes_df</span><span class="p">[</span><span class="n">lanes_df</span><span class="p">[</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">permitted_rows</span><span class="p">)]</span>
        <span class="n">allow_rtor_row</span> <span class="o">=</span> <span class="n">lanes_df</span><span class="p">[</span><span class="n">lanes_df</span><span class="p">[</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Allow RTOR&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">phase_idx</span><span class="p">,</span> <span class="n">phase_row</span> <span class="ow">in</span> <span class="n">phases_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;Phase&#39;</span><span class="p">]</span>
            <span class="n">protected_columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">protected_row</span> <span class="ow">in</span> <span class="n">existing_protected_rows</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">columns_with_P</span> <span class="o">=</span> <span class="n">protected_row</span><span class="p">[</span><span class="n">protected_row</span> <span class="o">==</span> <span class="n">P</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;INTID&#39;</span> <span class="ow">in</span> <span class="n">columns_with_P</span><span class="p">:</span>
                    <span class="n">columns_with_P</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;INTID&#39;</span><span class="p">)</span>
                <span class="n">protected_columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">columns_with_P</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">protected_columns</span><span class="p">:</span>
                <span class="n">phases_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">phase_idx</span><span class="p">,</span> <span class="s1">&#39;Protected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">protected_columns</span><span class="p">)</span>

            <span class="n">permitted_columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">permitted_row</span> <span class="ow">in</span> <span class="n">existing_permitted_rows</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">columns_with_P</span> <span class="o">=</span> <span class="n">permitted_row</span><span class="p">[</span><span class="n">permitted_row</span> <span class="o">==</span> <span class="n">P</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;INTID&#39;</span> <span class="ow">in</span> <span class="n">columns_with_P</span><span class="p">:</span>
                    <span class="n">columns_with_P</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;INTID&#39;</span><span class="p">)</span>
                <span class="n">permitted_columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">columns_with_P</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">permitted_columns</span><span class="p">:</span>
                <span class="n">phases_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">phase_idx</span><span class="p">,</span> <span class="s1">&#39;Permitted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">permitted_columns</span><span class="p">)</span>

            <span class="n">RTOR_columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_rtor_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">rtor_row</span> <span class="ow">in</span> <span class="n">allow_rtor_row</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">rtor_columns</span> <span class="o">=</span> <span class="n">rtor_row</span><span class="p">[</span><span class="n">rtor_row</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;INTID&#39;</span> <span class="ow">in</span> <span class="n">rtor_columns</span><span class="p">:</span>
                        <span class="n">rtor_columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;INTID&#39;</span><span class="p">)</span>
                    <span class="n">RTOR_columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rtor_columns</span><span class="p">)</span>
            <span class="n">RTOR_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">RTOR_columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">RTOR_columns</span><span class="p">:</span>
                <span class="n">phases_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">phase_idx</span><span class="p">,</span> <span class="s1">&#39;RTOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RTOR_columns</span><span class="p">)</span>

        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phases_df</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">thru</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;Protected&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">movements</span> <span class="o">=</span> <span class="n">thru</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">movement</span> <span class="ow">in</span> <span class="n">movements</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">movement</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">movement</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">lane_value</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">][</span><span class="s2">&quot;RECORDNAME&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Shared&quot;</span><span class="p">,</span> <span class="n">movement</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lane_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">lane_value</span> <span class="o">=</span> <span class="n">lane_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">lane_value</span><span class="p">)</span> <span class="ow">or</span> <span class="n">lane_value</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">left_turn</span> <span class="o">=</span> <span class="n">movement</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;L&quot;</span>
                        <span class="n">right_turn</span> <span class="o">=</span> <span class="n">movement</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;R&quot;</span>

                        <span class="n">turns_to_add</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">lane_value</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span> <span class="n">left_turn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">movements</span><span class="p">:</span>
                            <span class="n">turns_to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left_turn</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">lane_value</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span> <span class="ow">and</span> <span class="n">right_turn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">movements</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">right_turn</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;RTOR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                                <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;RTOR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;RTOR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">right_turn</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                            <span class="n">turns_to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">right_turn</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="n">lane_value</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">movement</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">movements</span><span class="p">:</span>
                                <span class="n">turns_to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">movement</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">right_turn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">movements</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">right_turn</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;RTOR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                                    <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;RTOR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;RTOR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">right_turn</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                                <span class="n">turns_to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">right_turn</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">turns_to_add</span><span class="p">:</span>
                            <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;Protected&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">movements</span> <span class="o">+</span> <span class="n">turns_to_add</span><span class="p">)</span>
                    <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;RTOR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;RTOR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,,&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_net</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">NetworkData</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">NetworkData</span><span class="p">))</span>
    <span class="n">TLLogic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;tlLogic&#39;</span><span class="p">):</span>
        <span class="n">TLLogic</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;tl&#39;</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="n">tl</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;tl&#39;</span><span class="p">]</span>
            <span class="n">linkIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;linkIndex&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">TLLogic</span><span class="p">:</span>
                <span class="n">TLLogic</span><span class="p">[</span><span class="n">tl</span><span class="p">][</span><span class="n">linkIndex</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">],</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">],</span> <span class="s1">&#39;dir&#39;</span><span class="p">:</span> <span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]}</span>

    <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">TLLogic</span><span class="p">:</span>
        <span class="n">TLLogic</span><span class="p">[</span><span class="n">tl</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">TLLogic</span><span class="p">[</span><span class="n">tl</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

    <span class="c1"># ## Please note: here we assume there is no phase only for U turn,</span>
    <span class="c1"># i.e. U turn is associated with a left turn or through movement</span>
    <span class="n">lookup_mapping</span> <span class="o">=</span> <span class="n">lookup_df</span><span class="p">[[</span><span class="s1">&#39;INTID&#39;</span><span class="p">,</span> <span class="s1">&#39;SumoJunctionID&#39;</span><span class="p">]]</span>

    <span class="c1"># Adding the &quot;SumoJunctionID&quot; attribute to each Synchro[intid]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">lookup_mapping</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">intid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span>
        <span class="n">tl</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SumoJunctionID&#39;</span><span class="p">]</span>
        <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;SumoJunctionID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tl</span>

    <span class="c1"># Matching Synchro[intid][&quot;Lanes&quot;] with TLLogic[tl] with additional checks</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">lookup_mapping</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">intid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span>
        <span class="n">tl</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SumoJunctionID&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">TLLogic</span><span class="p">:</span>
            <span class="n">current_tllogic</span> <span class="o">=</span> <span class="n">TLLogic</span><span class="p">[</span><span class="n">tl</span><span class="p">]</span>
            <span class="n">movement_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_dir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">dir_sequence</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">column_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">current_tllogic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">movement_values</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">column_index</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Group by &#39;from&#39;</span>
                <span class="n">from_groups</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">current_tllogic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">from_edge</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span>
                    <span class="n">from_groups</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">from_edge</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="p">[]})</span>  <span class="c1"># no separate &#39;t&#39; key now</span>
                    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
                        <span class="n">from_groups</span><span class="p">[</span><span class="n">from_edge</span><span class="p">][</span><span class="s1">&#39;l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>  <span class="c1"># treat &#39;t&#39; as &#39;l&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">from_groups</span><span class="p">[</span><span class="n">from_edge</span><span class="p">][</span><span class="n">direction</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">from_edge</span> <span class="ow">in</span> <span class="n">from_groups</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">dir_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">from_groups</span><span class="p">[</span><span class="n">from_edge</span><span class="p">][</span><span class="n">dir_key</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">column_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  :SUMO junction (id = </span><span class="si">{</span><span class="n">tl</span><span class="si">}</span><span class="s2">) has more movements than Synchro intersection (id = </span><span class="si">{</span><span class="n">intid</span><span class="si">}</span><span class="s2">). Please check.&quot;</span><span class="p">)</span>
                                <span class="k">break</span>
                            <span class="n">movement_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">from_groups</span><span class="p">[</span><span class="n">from_edge</span><span class="p">][</span><span class="n">dir_key</span><span class="p">]))</span>
                            <span class="n">column_index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># If there are remaining columns, print the message indicating the mismatch</span>
            <span class="k">if</span> <span class="n">column_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  :Synchro intersection (id = </span><span class="si">{</span><span class="n">intid</span><span class="si">}</span><span class="s2">) has more movements than SUMO junction (id = </span><span class="si">{</span><span class="n">tl</span><span class="si">}</span><span class="s2">). Please check.&quot;</span><span class="p">)</span>

            <span class="c1"># Ensure that the number of columns matches the existing columns in Synchro[intid][&quot;Lanes&quot;]</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">movement_values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">movement_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1"># Create a new row with &quot;Movement&quot; as RECORDNAME, intid as INTID, and TLLogic values</span>
            <span class="n">new_movement_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s1">&#39;Movement&#39;</span><span class="p">,</span> <span class="n">intid</span><span class="p">]</span> <span class="o">+</span> <span class="n">movement_values</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">],</span> <span class="n">new_movement_row</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Matching &quot;Movement&quot; of Synchro[intid][&quot;Lanes&quot;] with &quot;Protected&quot; and &quot;Permitted&quot; in Synchro[intid][&quot;Phases&quot;]</span>
    <span class="n">phase_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">intid</span> <span class="ow">in</span> <span class="n">Synchro</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">phases_df</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">]</span>
            <span class="n">lanes_df</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span>
            <span class="n">phases_df</span><span class="p">[</span><span class="s1">&#39;ProtectedMovement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">phases_df</span><span class="p">[</span><span class="s1">&#39;PermittedMovement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">phases_df</span><span class="p">[</span><span class="s1">&#39;RTORMovement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">movement_mapping</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">movement_row</span> <span class="o">=</span> <span class="n">lanes_df</span><span class="p">[</span><span class="n">lanes_df</span><span class="p">[</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Movement&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">lanes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="n">movement_mapping</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">movement_row</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">movement_row</span><span class="p">[</span><span class="n">column</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

            <span class="k">for</span> <span class="n">phase_idx</span><span class="p">,</span> <span class="n">phase_row</span> <span class="ow">in</span> <span class="n">phases_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">protected_columns</span> <span class="o">=</span> <span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;Protected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">protected_movements</span> <span class="o">=</span> <span class="p">[</span><span class="n">movement_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">protected_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">movement_mapping</span><span class="p">]</span>
                <span class="n">protected_movements</span> <span class="o">=</span> <span class="p">[</span><span class="n">mv</span> <span class="k">for</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">protected_movements</span> <span class="k">if</span> <span class="n">mv</span><span class="p">]</span>
                <span class="n">phases_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">phase_idx</span><span class="p">,</span> <span class="s1">&#39;ProtectedMovement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">protected_movements</span><span class="p">)</span>
                <span class="c1"># For &quot;PermittedMovement&quot;, extract and map the columns from &quot;Permitted&quot;</span>
                <span class="n">permitted_columns</span> <span class="o">=</span> <span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;Permitted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">permitted_movements</span> <span class="o">=</span> <span class="p">[</span><span class="n">movement_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">permitted_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">movement_mapping</span><span class="p">]</span>
                <span class="n">permitted_movements</span> <span class="o">=</span> <span class="p">[</span><span class="n">mv</span> <span class="k">for</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">permitted_movements</span> <span class="k">if</span> <span class="n">mv</span><span class="p">]</span>
                <span class="n">phases_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">phase_idx</span><span class="p">,</span> <span class="s1">&#39;PermittedMovement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">permitted_movements</span><span class="p">)</span>

                <span class="c1"># For &quot;RTORMovement&quot;, extract and map the columns from &quot;RTOR&quot;</span>
                <span class="n">RTOR_columns</span> <span class="o">=</span> <span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;RTOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">RTOR_movements</span> <span class="o">=</span> <span class="p">[</span><span class="n">movement_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">RTOR_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">movement_mapping</span><span class="p">]</span>
                <span class="n">RTOR_movements</span> <span class="o">=</span> <span class="p">[</span><span class="n">mv</span> <span class="k">for</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">RTOR_movements</span> <span class="k">if</span> <span class="n">mv</span><span class="p">]</span>  <span class="c1"># Remove any empty strings</span>
                <span class="n">phases_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">phase_idx</span><span class="p">,</span> <span class="s1">&#39;RTORMovement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RTOR_movements</span><span class="p">)</span>

            <span class="c1"># Update the &quot;Phases&quot; DataFrame in Synchro</span>
            <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">][</span><span class="s2">&quot;Phases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phases_df</span>
            <span class="n">phase_flag</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">phase_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="c1"># get sumo junction id form lookup_df</span>
            <span class="n">sumo_id</span> <span class="o">=</span> <span class="n">lookup_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lookup_df</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">intid</span><span class="p">,</span> <span class="s1">&#39;SumoJunctionID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  :Mismatch between SUMO junction </span><span class="si">{</span><span class="n">sumo_id</span><span class="si">}</span><span class="s2"> and &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;Synchro junction </span><span class="si">{</span><span class="n">intid</span><span class="si">}</span><span class="s2"> in the input MatchupTable.xlsx.&quot;</span><span class="p">)</span>
    <span class="c1"># # Uncomment this section if you want to raise an error when no phases are found</span>

    <span class="k">if</span> <span class="n">phase_flag</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="c1"># # No matching phases found</span>
    <span class="c1"># if phase_flag == 0:</span>
    <span class="c1">#     raise ValueError(&quot;No phases found in Synchro data.&quot;)</span>
    <span class="c1"># elif phase_flag &gt;= 0:</span>
    <span class="c1">#     # Not all phases matched</span>
    <span class="c1">#     if phase_flag != len(Synchro):</span>
    <span class="c1">#         print(f&quot;  :There are {len(Synchro) - phase_flag} intersections without phases. Please check.&quot;)</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">path_net</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="n">last_edge</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;edge&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">tlLogic_elem</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;tlLogic&#39;</span><span class="p">):</span>
        <span class="n">tl_id</span> <span class="o">=</span> <span class="n">tlLogic_elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">intid_row</span> <span class="o">=</span> <span class="n">lookup_df</span><span class="p">[</span><span class="n">lookup_df</span><span class="p">[</span><span class="s1">&#39;SumoJunctionID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tl_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">intid_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">intid</span> <span class="o">=</span> <span class="n">intid_row</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">synchro_data</span> <span class="o">=</span> <span class="n">Synchro</span><span class="p">[</span><span class="n">intid</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Timeplans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Timeplans&quot;</span><span class="p">][</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Offset&#39;</span><span class="p">,</span> <span class="s1">&#39;DATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">detect_lengths</span> <span class="o">=</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Lanes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Lanes&quot;</span><span class="p">][</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DetectSize1&#39;</span><span class="p">]</span>
        <span class="n">detect_lengths_float</span> <span class="o">=</span> <span class="n">detect_lengths</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
        <span class="n">detector_length</span> <span class="o">=</span> <span class="n">detect_lengths_float</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3048</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">detect_lengths</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">detector_length_left_turn</span> <span class="o">=</span> <span class="n">detect_lengths_float</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3048</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">detect_lengths</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="n">total_cycle_length</span> <span class="o">=</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Timeplans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Timeplans&quot;</span><span class="p">][</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Cycle Length&#39;</span><span class="p">,</span> <span class="s1">&#39;DATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_tlLogic</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;tlLogic&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">tl_id</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">programID</span><span class="o">=</span><span class="s2">&quot;NEMA&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;NEMA&quot;</span><span class="p">)</span>

        <span class="c1"># Add the param elements based on gathered data</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;detector-length&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">detector_length</span><span class="p">),</span>
            <span class="s2">&quot;detector-length-leftTurnLane&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">detector_length_left_turn</span><span class="p">),</span>
            <span class="s2">&quot;total-cycle-length&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_cycle_length</span><span class="p">),</span>
            <span class="s2">&quot;coordinate-mode&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span> <span class="k">if</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Timeplans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Timeplans&quot;</span><span class="p">][</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Control Type&#39;</span><span class="p">,</span> <span class="s1">&#39;DATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span> <span class="k">else</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
            <span class="s2">&quot;whetherOutputState&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
            <span class="s2">&quot;show-detectors&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
            <span class="s2">&quot;controllerType&quot;</span><span class="p">:</span> <span class="s2">&quot;Type 170&quot;</span> <span class="k">if</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Timeplans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Timeplans&quot;</span><span class="p">][</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Referenced To&#39;</span><span class="p">,</span> <span class="s1">&#39;DATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;TS2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fixForceOff&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span> <span class="k">if</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;InhibitMax&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;false&quot;</span>
        <span class="p">}</span>

        <span class="c1"># Add the &#39;coordinatePhases&#39; parameter conditionally</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;coordinate-mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
            <span class="n">reference_phase</span> <span class="o">=</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Timeplans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Timeplans&quot;</span><span class="p">][</span><span class="s1">&#39;RECORDNAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Reference Phase&#39;</span><span class="p">,</span> <span class="s1">&#39;DATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">RP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reference_phase</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">RP</span> <span class="o">&lt;=</span> <span class="mi">99</span><span class="p">:</span>
                <span class="n">coordinate_phases_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">RP</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coordinate_phases_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RP</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">100</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">RP</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">RP</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;coordinatePhases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinate_phases_value</span>

        <span class="c1"># Add the &#39;minRecall&#39; parameter</span>
        <span class="n">min_recall_subset</span> <span class="o">=</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;Recall&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">]</span>
        <span class="n">min_recall_value</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">min_recall_subset</span><span class="p">[</span><span class="s2">&quot;Phase&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">min_recall_subset</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;minRecall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_recall_value</span>
        <span class="k">if</span> <span class="n">FixedTime</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;minRecall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Add the &#39;maxRecall&#39; parameter</span>
        <span class="n">max_recall_subset</span> <span class="o">=</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;Recall&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">]</span>
        <span class="n">max_recall_value</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">max_recall_subset</span><span class="p">[</span><span class="s2">&quot;Phase&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">max_recall_subset</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;maxRecall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_recall_value</span>
        <span class="k">if</span> <span class="n">FixedTime</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;maxRecall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;Phase&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">new_tlLogic</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Adding &lt;param key=&quot;ringX&quot; value=&quot;&quot;/&gt; with the updated logic</span>
        <span class="n">max_ring</span> <span class="o">=</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;Ring&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">previous_phase</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">ring_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_ring</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">phases_in_ring</span> <span class="o">=</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;Ring&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">==</span> <span class="n">ring_num</span><span class="p">][</span><span class="s2">&quot;Phase&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">phases_in_ring</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">largest_phase</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">phases_in_ring</span><span class="p">)</span>
            <span class="n">complete_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">previous_phase</span><span class="p">,</span> <span class="n">largest_phase</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">phases_in_ring</span><span class="p">:</span>
                    <span class="n">complete_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">complete_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">previous_phase</span> <span class="o">=</span> <span class="n">largest_phase</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ring_value</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">complete_list</span><span class="p">))</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">new_tlLogic</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ring</span><span class="si">{</span><span class="n">ring_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ring_value</span><span class="p">)</span>

        <span class="n">max_barrier</span> <span class="o">=</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;Barrier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">barrier_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_barrier</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">barrier_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Find phases with the largest &quot;Barrier&quot; value</span>
                <span class="n">largest_barrier_row</span> <span class="o">=</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;Barrier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_barrier</span><span class="p">]</span>
                <span class="n">largest_phases</span> <span class="o">=</span> <span class="n">largest_barrier_row</span><span class="p">[</span><span class="n">largest_barrier_row</span><span class="p">[</span><span class="s2">&quot;Position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">==</span> <span class="n">largest_barrier_row</span><span class="p">[</span><span class="s2">&quot;Position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()][</span><span class="s2">&quot;Phase&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">barrier_value</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">largest_phases</span><span class="p">)))</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">new_tlLogic</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;barrierPhases&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">barrier_value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Find the previous barrier phases</span>
                <span class="n">previous_barrier_row</span> <span class="o">=</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">][</span><span class="s2">&quot;Barrier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">==</span> <span class="n">barrier_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">largest_phases</span> <span class="o">=</span> <span class="n">previous_barrier_row</span><span class="p">[</span><span class="n">previous_barrier_row</span><span class="p">[</span><span class="s2">&quot;Position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">==</span> <span class="n">previous_barrier_row</span><span class="p">[</span><span class="s2">&quot;Position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()][</span><span class="s2">&quot;Phase&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">barrier_value</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">largest_phases</span><span class="p">)))</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">new_tlLogic</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;barrier</span><span class="si">{</span><span class="n">barrier_num</span><span class="si">}</span><span class="s2">Phases&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">barrier_value</span><span class="p">)</span>

        <span class="c1"># Check and swap barrier phases if needed</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;coordinate-mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
            <span class="c1"># Extract the values of &#39;coordinatePhases&#39;, &#39;barrierPhases&#39;, and &#39;barrier2Phases&#39;</span>
            <span class="n">coordinate_phases_value</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coordinatePhases&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">barrier_phases_value</span> <span class="o">=</span> <span class="n">new_tlLogic</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./param[@key=&#39;barrierPhases&#39;]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">barrier2_phases_element</span> <span class="o">=</span> <span class="n">new_tlLogic</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./param[@key=&#39;barrier2Phases&#39;]&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">barrier2_phases_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">barrier2_phases_value</span> <span class="o">=</span> <span class="n">barrier2_phases_element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

                <span class="c1"># Check if &#39;barrier2Phases&#39; is the same as &#39;coordinatePhases&#39;</span>
                <span class="k">if</span> <span class="n">barrier2_phases_value</span> <span class="o">!=</span> <span class="n">coordinate_phases_value</span><span class="p">:</span>
                    <span class="n">new_tlLogic</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./param[@key=&#39;barrierPhases&#39;]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">barrier2_phases_value</span>
                    <span class="n">barrier2_phases_element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">barrier_phases_value</span>

                <span class="c1"># Recheck if &#39;barrier2Phases&#39; is still not the same as &#39;coordinatePhases&#39;</span>
                <span class="k">if</span> <span class="n">barrier2_phases_element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">coordinate_phases_value</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  :Error with barrier phases and coordinated phases at &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;intersection </span><span class="si">{</span><span class="n">intid_row</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, please modify manually.&quot;</span><span class="p">)</span>

        <span class="n">nm</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">TLLogic</span><span class="p">[</span><span class="n">tl_id</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">phase_row</span> <span class="ow">in</span> <span class="n">synchro_data</span><span class="p">[</span><span class="s2">&quot;Phases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">generate_complete_state_string</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;ProtectedMovement&#39;</span><span class="p">],</span> <span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;PermittedMovement&#39;</span><span class="p">],</span> <span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;RTORMovement&#39;</span><span class="p">],</span> <span class="n">nm</span><span class="p">)</span>
            <span class="n">maxDur</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;MaxGreen&#39;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;MaxGreen&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">total_cycle_length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;MaxGreen&#39;</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  :Maximum green(&#39;MaxGreen&#39;) is missing for phase </span><span class="si">{</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;Phase&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> at &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;intersection </span><span class="si">{</span><span class="n">intid_row</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">total_cycle_length</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> sec is used.&quot;</span>
                      <span class="s2">&quot; Manual change is probably needed to ensure the length of this ring equal to cycle length.&quot;</span><span class="p">)</span>

            <span class="n">minDur</span> <span class="o">=</span> <span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;MinGreen&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;MinGreen&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxDur</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;MinGreen&#39;</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  :Minimum green(&#39;MinGreen&#39;) is missing for phase </span><span class="si">{</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;Phase&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> at &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;intersection </span><span class="si">{</span><span class="n">intid_row</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">maxDur</span><span class="p">)</span><span class="si">}</span><span class="s2"> sec is used&quot;</span><span class="p">)</span>

            <span class="n">vehext</span> <span class="o">=</span> <span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;VehExt&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;VehExt&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;VehExt&#39;</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  :Added green per actuation (&#39;vehext&#39;) is missing for phase </span><span class="si">{</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;Phase&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> at &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;intersection </span><span class="si">{</span><span class="n">intid_row</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, 2 sec is used.&quot;</span><span class="p">)</span>

            <span class="n">yellow</span> <span class="o">=</span> <span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;Yellow&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;Yellow&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;Yellow&#39;</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  :Yellow time(&#39;Yellow&#39;) is missing for phase </span><span class="si">{</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;Phase&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> at &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;intersection </span><span class="si">{</span><span class="n">intid_row</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, 3 sec is used.&quot;</span><span class="p">)</span>

            <span class="n">red</span> <span class="o">=</span> <span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;AllRed&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;AllRed&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;AllRed&#39;</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  :All red time (&#39;AllRed&#39;) is missing for phase </span><span class="si">{</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;Phase&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> at &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;intersection </span><span class="si">{</span><span class="n">intid_row</span><span class="p">[</span><span class="s1">&#39;INTID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, 0 sec is used.&quot;</span><span class="p">)</span>

            <span class="c1"># Add the phase element</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">new_tlLogic</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;99&quot;</span><span class="p">,</span> <span class="n">minDur</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">minDur</span><span class="p">),</span>
                          <span class="n">maxDur</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">maxDur</span><span class="p">),</span> <span class="n">vehext</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">vehext</span><span class="p">),</span>
                          <span class="n">yellow</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">yellow</span><span class="p">),</span> <span class="n">red</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">red</span><span class="p">),</span>
                          <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">phase_row</span><span class="p">[</span><span class="s1">&#39;Phase&#39;</span><span class="p">]),</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>

        <span class="c1"># Replace the existing tlLogic element with the new one in the parent element</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//tlLogic/..&quot;</span><span class="p">)</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tlLogic_elem</span><span class="p">)</span>
        <span class="c1"># Insert the new tlLogic element right after the last &lt;edge&gt; element</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">last_edge</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_tlLogic</span><span class="p">)</span>

    <span class="n">tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path_net</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>

    <span class="n">prettify_xml</span><span class="p">(</span><span class="n">path_net</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025 - 2025, ORNL-RealTwin.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>